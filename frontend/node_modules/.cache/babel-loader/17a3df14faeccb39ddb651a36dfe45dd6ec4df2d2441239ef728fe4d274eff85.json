{"ast":null,"code":"var _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport { useMutation, useQuery } from 'react-query';\nimport { useAuthStore } from '../stores/authStore';\nimport { authApi } from '../api/auth';\nimport toast from 'react-hot-toast';\nexport const useAuth = () => {\n  _s();\n  const {\n    login,\n    logout,\n    updateUser\n  } = useAuthStore();\n\n  // 登录\n  const loginMutation = useMutation({\n    mutationFn: authApi.login,\n    onSuccess: data => {\n      login(data.user, data.token);\n      toast.success('登录成功！');\n    },\n    onError: error => {\n      var _error$response, _error$response$data;\n      toast.error(((_error$response = error.response) === null || _error$response === void 0 ? void 0 : (_error$response$data = _error$response.data) === null || _error$response$data === void 0 ? void 0 : _error$response$data.error) || '登录失败');\n    }\n  });\n\n  // 注册\n  const registerMutation = useMutation({\n    mutationFn: authApi.register,\n    onSuccess: data => {\n      login(data.user, data.token);\n      toast.success('注册成功！');\n    },\n    onError: error => {\n      var _error$response2, _error$response3;\n      console.log('Registration error:', (_error$response2 = error.response) === null || _error$response2 === void 0 ? void 0 : _error$response2.data);\n\n      // 处理详细的字段错误信息\n      const errorData = (_error$response3 = error.response) === null || _error$response3 === void 0 ? void 0 : _error$response3.data;\n      if (errorData) {\n        let errorMessages = [];\n\n        // 处理密码错误\n        if (errorData.password && Array.isArray(errorData.password)) {\n          errorMessages = errorMessages.concat(errorData.password);\n        }\n\n        // 处理邮箱错误\n        if (errorData.email && Array.isArray(errorData.email)) {\n          errorMessages = errorMessages.concat(errorData.email);\n        }\n\n        // 处理昵称错误\n        if (errorData.nickname && Array.isArray(errorData.nickname)) {\n          errorMessages = errorMessages.concat(errorData.nickname);\n        }\n\n        // 处理确认密码错误\n        if (errorData.password_confirm && Array.isArray(errorData.password_confirm)) {\n          errorMessages = errorMessages.concat(errorData.password_confirm);\n        }\n\n        // 处理非字段错误\n        if (errorData.non_field_errors && Array.isArray(errorData.non_field_errors)) {\n          errorMessages = errorMessages.concat(errorData.non_field_errors);\n        }\n\n        // 显示所有错误信息\n        if (errorMessages.length > 0) {\n          errorMessages.forEach(message => {\n            toast.error(message);\n          });\n        } else {\n          toast.error(errorData.error || errorData.detail || '注册失败');\n        }\n      } else {\n        toast.error('注册失败，请稍后重试');\n      }\n    }\n  });\n\n  // 登出\n  const logoutMutation = useMutation({\n    mutationFn: authApi.logout,\n    onSuccess: () => {\n      logout();\n      toast.success('已退出登录');\n    },\n    onError: () => {\n      // 即使API调用失败，也要清除本地状态\n      logout();\n    }\n  });\n\n  // 更新用户信息\n  const updateUserMutation = useMutation({\n    mutationFn: authApi.updateUser,\n    onSuccess: data => {\n      updateUser(data);\n      toast.success('资料更新成功！');\n    },\n    onError: error => {\n      var _error$response4, _error$response4$data;\n      toast.error(((_error$response4 = error.response) === null || _error$response4 === void 0 ? void 0 : (_error$response4$data = _error$response4.data) === null || _error$response4$data === void 0 ? void 0 : _error$response4$data.error) || '更新失败');\n    }\n  });\n\n  // 关注用户\n  const followUserMutation = useMutation({\n    mutationFn: authApi.followUser,\n    onSuccess: () => {\n      toast.success('关注成功！');\n    },\n    onError: error => {\n      var _error$response5, _error$response5$data;\n      toast.error(((_error$response5 = error.response) === null || _error$response5 === void 0 ? void 0 : (_error$response5$data = _error$response5.data) === null || _error$response5$data === void 0 ? void 0 : _error$response5$data.error) || '关注失败');\n    }\n  });\n\n  // 取消关注用户\n  const unfollowUserMutation = useMutation({\n    mutationFn: authApi.unfollowUser,\n    onSuccess: () => {\n      toast.success('取消关注成功！');\n    },\n    onError: error => {\n      var _error$response6, _error$response6$data;\n      toast.error(((_error$response6 = error.response) === null || _error$response6 === void 0 ? void 0 : (_error$response6$data = _error$response6.data) === null || _error$response6$data === void 0 ? void 0 : _error$response6$data.error) || '取消关注失败');\n    }\n  });\n  return {\n    login: loginMutation.mutate,\n    register: registerMutation.mutate,\n    logout: logoutMutation.mutate,\n    updateUser: updateUserMutation.mutate,\n    followUser: followUserMutation.mutate,\n    unfollowUser: unfollowUserMutation.mutate,\n    isLoading: loginMutation.isLoading || registerMutation.isLoading\n  };\n};\n\n// 获取当前用户信息的Hook\n_s(useAuth, \"4ZeINTfOysy1lPDPeJvipZgvY4Q=\", false, function () {\n  return [useAuthStore, useMutation, useMutation, useMutation, useMutation, useMutation, useMutation];\n});\nexport const useCurrentUser = () => {\n  _s2();\n  const {\n    user,\n    token,\n    isAuthenticated\n  } = useAuthStore();\n  return useQuery({\n    queryKey: ['currentUser'],\n    queryFn: authApi.getCurrentUser,\n    enabled: isAuthenticated && !!token,\n    staleTime: 5 * 60 * 1000,\n    // 5分钟\n    retry: false\n  });\n};\n_s2(useCurrentUser, \"w1wybh/lVbV/zSAbYNjUy0SIsNY=\", false, function () {\n  return [useAuthStore, useQuery];\n});","map":{"version":3,"names":["useMutation","useQuery","useAuthStore","authApi","toast","useAuth","_s","login","logout","updateUser","loginMutation","mutationFn","onSuccess","data","user","token","success","onError","error","_error$response","_error$response$data","response","registerMutation","register","_error$response2","_error$response3","console","log","errorData","errorMessages","password","Array","isArray","concat","email","nickname","password_confirm","non_field_errors","length","forEach","message","detail","logoutMutation","updateUserMutation","_error$response4","_error$response4$data","followUserMutation","followUser","_error$response5","_error$response5$data","unfollowUserMutation","unfollowUser","_error$response6","_error$response6$data","mutate","isLoading","useCurrentUser","_s2","isAuthenticated","queryKey","queryFn","getCurrentUser","enabled","staleTime","retry"],"sources":["D:/miko/frontend/src/hooks/useAuth.ts"],"sourcesContent":["import { useMutation, useQuery } from 'react-query';\r\nimport { useAuthStore } from '../stores/authStore';\r\nimport { authApi } from '../api/auth';\r\nimport { LoginRequest, RegisterRequest } from '../types/user';\r\nimport toast from 'react-hot-toast';\r\n\r\nexport const useAuth = () => {\r\n  const { login, logout, updateUser } = useAuthStore();\r\n\r\n  // 登录\r\n  const loginMutation = useMutation({\r\n    mutationFn: authApi.login,\r\n    onSuccess: (data) => {\r\n      login(data.user, data.token);\r\n      toast.success('登录成功！');\r\n    },\r\n    onError: (error: any) => {\r\n      toast.error(error.response?.data?.error || '登录失败');\r\n    },\r\n  });\r\n\r\n  // 注册\r\n  const registerMutation = useMutation({\r\n    mutationFn: authApi.register,\r\n    onSuccess: (data) => {\r\n      login(data.user, data.token);\r\n      toast.success('注册成功！');\r\n    },\r\n    onError: (error: any) => {\r\n      console.log('Registration error:', error.response?.data);\r\n      \r\n      // 处理详细的字段错误信息\r\n      const errorData = error.response?.data;\r\n      if (errorData) {\r\n        let errorMessages: string[] = [];\r\n        \r\n        // 处理密码错误\r\n        if (errorData.password && Array.isArray(errorData.password)) {\r\n          errorMessages = errorMessages.concat(errorData.password);\r\n        }\r\n        \r\n        // 处理邮箱错误\r\n        if (errorData.email && Array.isArray(errorData.email)) {\r\n          errorMessages = errorMessages.concat(errorData.email);\r\n        }\r\n        \r\n        // 处理昵称错误\r\n        if (errorData.nickname && Array.isArray(errorData.nickname)) {\r\n          errorMessages = errorMessages.concat(errorData.nickname);\r\n        }\r\n        \r\n        // 处理确认密码错误\r\n        if (errorData.password_confirm && Array.isArray(errorData.password_confirm)) {\r\n          errorMessages = errorMessages.concat(errorData.password_confirm);\r\n        }\r\n        \r\n        // 处理非字段错误\r\n        if (errorData.non_field_errors && Array.isArray(errorData.non_field_errors)) {\r\n          errorMessages = errorMessages.concat(errorData.non_field_errors);\r\n        }\r\n        \r\n        // 显示所有错误信息\r\n        if (errorMessages.length > 0) {\r\n          errorMessages.forEach(message => {\r\n            toast.error(message);\r\n          });\r\n        } else {\r\n          toast.error(errorData.error || errorData.detail || '注册失败');\r\n        }\r\n      } else {\r\n        toast.error('注册失败，请稍后重试');\r\n      }\r\n    },\r\n  });\r\n\r\n  // 登出\r\n  const logoutMutation = useMutation({\r\n    mutationFn: authApi.logout,\r\n    onSuccess: () => {\r\n      logout();\r\n      toast.success('已退出登录');\r\n    },\r\n    onError: () => {\r\n      // 即使API调用失败，也要清除本地状态\r\n      logout();\r\n    },\r\n  });\r\n\r\n  // 更新用户信息\r\n  const updateUserMutation = useMutation({\r\n    mutationFn: authApi.updateUser,\r\n    onSuccess: (data) => {\r\n      updateUser(data);\r\n      toast.success('资料更新成功！');\r\n    },\r\n    onError: (error: any) => {\r\n      toast.error(error.response?.data?.error || '更新失败');\r\n    },\r\n  });\r\n\r\n  // 关注用户\r\n  const followUserMutation = useMutation({\r\n    mutationFn: authApi.followUser,\r\n    onSuccess: () => {\r\n      toast.success('关注成功！');\r\n    },\r\n    onError: (error: any) => {\r\n      toast.error(error.response?.data?.error || '关注失败');\r\n    },\r\n  });\r\n\r\n  // 取消关注用户\r\n  const unfollowUserMutation = useMutation({\r\n    mutationFn: authApi.unfollowUser,\r\n    onSuccess: () => {\r\n      toast.success('取消关注成功！');\r\n    },\r\n    onError: (error: any) => {\r\n      toast.error(error.response?.data?.error || '取消关注失败');\r\n    },\r\n  });\r\n\r\n  return {\r\n    login: loginMutation.mutate,\r\n    register: registerMutation.mutate,\r\n    logout: logoutMutation.mutate,\r\n    updateUser: updateUserMutation.mutate,\r\n    followUser: followUserMutation.mutate,\r\n    unfollowUser: unfollowUserMutation.mutate,\r\n    isLoading: loginMutation.isLoading || registerMutation.isLoading,\r\n  };\r\n};\r\n\r\n// 获取当前用户信息的Hook\r\nexport const useCurrentUser = () => {\r\n  const { user, token, isAuthenticated } = useAuthStore();\r\n\r\n  return useQuery({\r\n    queryKey: ['currentUser'],\r\n    queryFn: authApi.getCurrentUser,\r\n    enabled: isAuthenticated && !!token,\r\n    staleTime: 5 * 60 * 1000, // 5分钟\r\n    retry: false,\r\n  });\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}